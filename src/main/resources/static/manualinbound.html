<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>MA Inbound Manual Suite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        /* Background (served from /warehouse.jpg) */
        body {
          margin: 0;
          padding: 0;
          font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        }
        body::before {
          content: "";
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-image: url("/warehouse.jpg");
          background-size: cover;
          background-position: center;
          filter: brightness(0.3) blur(2px);
          z-index: -1;
        }

        .step-label { transition: opacity 150ms ease, transform 150ms ease; }
        .step-label:hover { transform: translateY(-3px); }

        .back-btn { z-index: 90; }
    </style>
</head>

<body class="text-slate-100 flex justify-center items-start min-h-screen py-10">

<!-- Back button -->
<a href="inbound.html"
   class="back-btn fixed top-5 left-5 z-50 bg-slate-900/80 border border-slate-700 text-slate-200 px-4 py-2 rounded-full text-sm font-medium hover:bg-slate-800 hover:text-white transition shadow-lg backdrop-blur">
    ← Back
</a>

<div class="w-full max-w-5xl bg-slate-900/80 border border-slate-800 rounded-2xl shadow-2xl p-8 backdrop-blur-md">

    <!-- HEADER -->
    <div class="flex items-center justify-center gap-3 mb-6">
        <div class="w-12 h-12 rounded-2xl bg-emerald-500/10 border border-emerald-500/40 flex items-center justify-center text-emerald-300 font-bold text-base">
            MA
        </div>
        <div class="text-center">
            <h1 class="text-2xl font-semibold text-slate-100 tracking-tight drop-shadow-md">
                Manhattan Active Inbound Manual Suite
            </h1>
            <p class="text-sm text-slate-400">Manually driven inbound flow runner with Excel input control</p>
        </div>
    </div>

    <!-- ENV + DATASET CONTROLS -->
    <div class="flex flex-wrap justify-center items-center gap-4 mb-8">
        <div class="text-center">
            <label class="block text-xs text-slate-400 mb-1">Select Environment</label>
            <select id="envSelect" class="bg-slate-950/70 border border-slate-800 rounded-full px-5 py-2 text-sm text-slate-200 focus:ring-emerald-500 focus:ring-1 w-40 text-center shadow-md">
                <option value="DEV">DEV</option>
                <option value="QA">QA</option>
                <option value="PROD">PROD</option>
            </select>
        </div>
        <div class="text-center">
            <label class="block text-xs text-slate-400 mb-1">Select Dataset</label>
            <select id="datasetSelect" class="bg-slate-950/70 border border-slate-800 rounded-full px-5 py-2 text-sm text-slate-200 focus:ring-emerald-500 focus:ring-1 w-44 text-center shadow-md">
                <option value="default">Default</option>
                <option value="smoke">Smoke</option>
                <option value="regression">Regression</option>
            </select>
        </div>
    </div>

    <!-- CONTROLS -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

        <!-- Step Selection -->
        <div>
            <label class="block text-base font-semibold text-slate-200 mb-4 text-center">Select Manual Steps to Run</label>

            <!-- Select Item / LPN -->
            <div class="flex flex-wrap justify-center gap-3 mb-6">
                <label class="flex items-center gap-2 bg-slate-950/70 border border-slate-800 rounded-full px-4 py-2 cursor-pointer hover:bg-slate-900/70 transition">
                    <input type="checkbox" id="selectAllItemFlow" class="accent-emerald-500 w-4 h-4">
                    <span class="text-slate-100 font-medium text-xs">Select All (Item Flow)</span>
                </label>

                <label class="flex items-center gap-2 bg-slate-950/70 border border-slate-800 rounded-full px-4 py-2 cursor-pointer hover:bg-slate-900/70 transition">
                    <input type="checkbox" id="selectAllLpnFlow" class="accent-emerald-500 w-4 h-4">
                    <span class="text-slate-100 font-medium text-xs">Select All (LPN Flow)</span>
                </label>
            </div>

            <div id="stepGroup" class="grid sm:grid-cols-2 gap-4">

                <!-- Step 1 -->
                <label class="step-label cursor-pointer flex items-center gap-3 bg-slate-950/70 border border-slate-800 rounded-xl px-4 py-3 text-sm hover:bg-slate-900/80 transition" data-step="step1">
                    <input type="checkbox" value="step1" class="step-checkbox accent-emerald-500 w-4 h-4">
                    <p class="font-medium text-slate-100">Login</p>
                </label>

                <!-- Step 2 -->
                <label class="step-label cursor-pointer flex items-center gap-3 bg-slate-950/70 border border-slate-800 rounded-xl px-4 py-3 text-sm hover:bg-slate-900/80 transition" data-step="step2">
                    <input type="checkbox" value="step2" class="step-checkbox accent-emerald-500 w-4 h-4">
                    <p class="font-medium text-slate-100">Create LPN LVL ASN</p>
                </label>

                <!-- Step 3 -->
                <label class="step-label cursor-pointer flex items-center gap-3 bg-slate-950/70 border border-slate-800 rounded-xl px-4 py-3 text-sm hover:bg-slate-900/80 transition" data-step="step3">
                    <input type="checkbox" value="step3" class="step-checkbox accent-emerald-500 w-4 h-4">
                    <p class="font-medium text-slate-100">Create ITEM LVL ASN</p>
                </label>

                <!-- Step 11 -->
                <label class="step-label cursor-pointer flex items-center gap-3 bg-slate-950/70 border border-slate-800 rounded-xl px-4 py-3 text-sm hover:bg-slate-900/80 transition" data-step="step11">
                    <input type="checkbox" value="step11" class="step-checkbox accent-emerald-500 w-4 h-4">
                    <p class="font-medium text-slate-100">Manual Item-level Receiving</p>
                </label>

                <!-- Step 12 -->
                <label class="step-label cursor-pointer flex items-center gap-3 bg-slate-950/70 border border-slate-800 rounded-xl px-4 py-3 text-sm hover:bg-slate-900/80 transition" data-step="step12">
                    <input type="checkbox" value="step12" class="step-checkbox accent-emerald-500 w-4 h-4">
                    <p class="font-medium text-slate-100">Manual LPN-level Receiving</p>
                </label>

                <!-- Step 13 -->
                <label class="step-label cursor-pointer flex items-center gap-3 bg-slate-950/70 border border-slate-800 rounded-xl px-4 py-3 text-sm hover:bg-slate-900/80 transition" data-step="step13">
                    <input type="checkbox" value="step13" class="step-checkbox accent-emerald-500 w-4 h-4">
                    <p class="font-medium text-slate-100">Manual Pallet Putaway</p>
                </label>

            </div>

            <div class="flex gap-3 mt-6">
                <button id="runBtn"
                        class="flex-1 rounded-full border border-emerald-500/60 bg-emerald-500/10 px-5 py-2.5 text-sm font-semibold text-emerald-300 hover:bg-emerald-500 hover:text-slate-900 transition disabled:opacity-50">
                    ▶ Run Selected Steps
                </button>

                <!-- STOP button: new feature -->
                <button id="stopBtn"
                        class="w-36 rounded-full border border-rose-500/60 bg-rose-500/10 px-4 py-2.5 text-sm font-semibold text-rose-300 hover:bg-rose-500 hover:text-slate-900 transition disabled:opacity-50"
                        disabled>
                    ■ Stop
                </button>
            </div>

            <div id="statusText" class="text-center text-sm font-semibold mt-4"></div>
        </div>

        <!-- Excel Upload -->
        <div>
            <label class="block text-base font-semibold text-slate-200 mb-4 text-center">Upload Excel Data File</label>
            <input type="file" id="excelFile" accept=".xlsx,.csv"
                   class="w-full text-sm file:mr-3 file:py-2 file:px-4 file:rounded-full file:border-0 file:bg-emerald-500/20 file:text-emerald-300 file:font-semibold hover:file:bg-emerald-500 hover:file:text-slate-900 transition" />

            <div id="excelPreview" class="bg-slate-950/70 border border-slate-800 rounded-xl mt-4 p-3 h-60 overflow-auto text-xs text-slate-300">
                Upload an Excel file to preview data...
            </div>
        </div>
    </div>

    <!-- LOGS -->
    <div class="mt-10 bg-slate-950/80 border border-slate-800 rounded-xl p-4 h-56 overflow-auto font-mono text-xs text-slate-300" id="log">
        Logs will appear here...
    </div>

    <!-- FOOTER -->
    <footer class="border-t border-slate-800 text-center text-[11px] text-slate-500 mt-6 pt-3">
        © 2025 MA MSG Suite | Built with Tailwind + Spring Boot
    </footer>

</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Re-entrancy guard
        let isSyncing = false;

        // DOM helpers
        const runBtn = document.getElementById('runBtn');
        const stopBtn = document.getElementById('stopBtn');
        const log = document.getElementById('log');
        const statusText = document.getElementById('statusText');
        const excelInput = document.getElementById('excelFile');
        const excelPreview = document.getElementById('excelPreview');
        const envSelect = document.getElementById('envSelect');
        const datasetSelect = document.getElementById('datasetSelect');

        const selectItemFlow = document.getElementById('selectAllItemFlow');
        const selectLpnFlow  = document.getElementById('selectAllLpnFlow');
        const stepCheckboxes = Array.from(document.querySelectorAll('.step-checkbox'));

        // Flow definitions:
        // Item Flow → steps 1, 3, 11, 13 (disable 2, 12)
        // LPN Flow  → steps 1, 2, 12, 13 (disable 3, 11)
        const itemFlowValues = ['step1', 'step3', 'step11', 'step13'];
        const lpnFlowValues  = ['step1', 'step2', 'step12', 'step13'];
        const allSteps       = ['step1','step2','step3','step11','step12','step13'];

        function getCheckbox(stepVal) {
          return document.querySelector('.step-checkbox[value="' + stepVal + '"]');
        }

        function getLabel(stepVal) {
          return document.querySelector('label[data-step="' + stepVal + '"]');
        }

        function setDisabled(stepVal, disabled) {
          const cb = getCheckbox(stepVal);
          const label = getLabel(stepVal);
          if (!cb || !label) return;

          cb.disabled = !!disabled;
          if (disabled) {
            cb.checked = false; // clear if disabling
            label.classList.add('opacity-40', 'pointer-events-none');
          } else {
            label.classList.remove('opacity-40', 'pointer-events-none');
          }
        }

        function setFlowSelection(values, checked) {
          values.forEach(function (v) {
            const cb = getCheckbox(v);
            if (cb) cb.checked = !!checked;
          });
        }

        function resetAllSteps() {
          allSteps.forEach(function(step) {
            setDisabled(step, false);
            const cb = getCheckbox(step);
            if (cb) cb.checked = false;
          });
        }

        // ---------------- ITEM FLOW ----------------
        selectItemFlow.addEventListener('change', function (e) {
          if (isSyncing) return;
          isSyncing = true;
          try {
            const checked = e.target.checked;

            if (checked) {
              // make LPN flow mutually exclusive
              selectLpnFlow.checked = false;

              // full reset then apply item flow selection
              resetAllSteps();
              setFlowSelection(itemFlowValues, true);

              // disable step2 & step12 when item flow is active
              setDisabled('step2', true);
              setDisabled('step12', true);

            } else {
              // deselect from select-all → everything reset & deselected
              resetAllSteps();
            }
          } finally {
            isSyncing = false;
          }
        });

        // ---------------- LPN FLOW ----------------
        selectLpnFlow.addEventListener('change', function (e) {
          if (isSyncing) return;
          isSyncing = true;
          try {
            const checked = e.target.checked;

            if (checked) {
              // make item flow mutually exclusive
              selectItemFlow.checked = false;

              // full reset then apply LPN flow selection
              resetAllSteps();
              setFlowSelection(lpnFlowValues, true);

              // disable step3 & step11 when LPN flow is active
              setDisabled('step3', true);
              setDisabled('step11', true);

            } else {
              // deselect from select-all → everything reset & deselected
              resetAllSteps();
            }
          } finally {
            isSyncing = false;
          }
        });

        // --- Excel Upload + Preview ---
        excelInput.addEventListener('change', function (e) {
          const file = e.target.files[0];
          if (!file) return;
          const reader = new FileReader();
          reader.onload = function (evt) {
            const data = evt.target.result;
            const workbook = XLSX.read(data, { type: 'binary' });
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });
            let html = "<table class='min-w-full text-xs border-collapse'>";
            json.slice(0, 10).forEach(function (row) {
              html += "<tr>" + row.map(function (cell) {
                return "<td class='border border-slate-700 px-2 py-1'>" + (cell || '') + "</td>";
              }).join('') + "</tr>";
            });
            html += "</table>";
            excelPreview.innerHTML = html;
          };
          reader.readAsBinaryString(file);
        });

        // --- Run / Stop Button Logic ---
        let currentJobId = null;
        let pollInterval = null;
        let runAbortController = null; // used to abort the initial run request if needed

        function enableStopButton(enable) {
          stopBtn.disabled = !enable;
        }

        runBtn.addEventListener('click', async function () {
          const selectedSteps = stepCheckboxes
            .filter(function (cb) { return cb.checked; })
            .map(function (cb) { return cb.value; });

          // NEW VALIDATION:
          // If user selected step1 AND step13, they must also select step11 or step12.
          if (selectedSteps.includes('step1') && selectedSteps.includes('step13') &&
              !selectedSteps.includes('step11') && !selectedSteps.includes('step12')) {
            alert('When running Login (step1) together with Manual Pallet Putaway (step13), you must also select Manual Item-level Receiving (step11) or Manual LPN-level Receiving (step12). Please select step11 or step12 and try again.');
            return; // prevent run
          }

          if (selectedSteps.length === 0) {
            alert("Please select at least one step to run!");
            return;
          }

          const env = envSelect.value;
          const dataset = datasetSelect.value;

          log.textContent =
            "Environment: " + env +
            "\nDataset: " + dataset +
            "\nSteps: " + selectedSteps.join(', ') + "\n\n";

          statusText.textContent = 'Starting job...';
          statusText.className = 'text-center text-slate-300 font-semibold';
          runBtn.disabled = true;
          enableStopButton(true);

          try {
            // use AbortController so Stop can abort this request if needed
            runAbortController = new AbortController();

            const res = await fetch('/api/run', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ steps: selectedSteps, env: env, dataset: dataset }),
              signal: runAbortController.signal
            });

            if (!res.ok) throw new Error('Failed to start job: ' + res.status);

            const data = await res.json();
            const jobId = data.jobId;
            currentJobId = jobId;
            statusText.textContent = 'Job started: ' + jobId;

            // start polling
            pollInterval = setInterval(async function () {
              try {
                const r = await fetch('/api/status/' + jobId);
                if (!r.ok) throw new Error('Status fetch failed: ' + r.status);
                const job = await r.json();

                log.textContent += "Status: " + job.status + "\n";

                if (job.status.startsWith('finished')) {
                  clearInterval(pollInterval);
                  pollInterval = null;
                  currentJobId = null;
                  statusText.textContent = '✅ Finished successfully';
                  runBtn.disabled = false;
                  enableStopButton(false);
                } else if (job.status.startsWith('failed')) {
                  clearInterval(pollInterval);
                  pollInterval = null;
                  currentJobId = null;
                  statusText.textContent = '❌ Failed: ' + job.status;
                  runBtn.disabled = false;
                  enableStopButton(false);
                } else if (job.status.startsWith('stopped') || job.status.startsWith('cancelled') || job.status.startsWith('cancelled_by_interrupt')) {
                  clearInterval(pollInterval);
                  pollInterval = null;
                  currentJobId = null;
                  statusText.textContent = '⏸️ Stopped: ' + job.status;
                  runBtn.disabled = false;
                  enableStopButton(false);
                }
              } catch (pollErr) {
                // if polling errors out, log it but keep trying until stop pressed or job completes
                log.textContent += 'Polling error: ' + pollErr + '\n';
              }
            }, 2000);

          } catch (err) {
            // request failed or was aborted
            if (err.name === 'AbortError') {
              statusText.textContent = '❌ Job start aborted';
            } else {
              statusText.textContent = '❌ Error: ' + (err.message || err);
            }
            runBtn.disabled = false;
            enableStopButton(false);
          } finally {
            runAbortController = null;
          }
        });

        // STOP button behavior: stop polling and attempt to cancel job on server
        stopBtn.addEventListener('click', async function () {
          // disable stop button immediately to avoid double clicks
          enableStopButton(false);

          // Abort the initial run request if it's still in-flight
          try {
            if (runAbortController) runAbortController.abort();
          } catch (e) {
            // ignore
          }

          // clear client-side poll timer
          try {
            if (pollInterval) {
              clearInterval(pollInterval);
              pollInterval = null;
            }
          } catch (e) {}

          // If we have a server-side job id, attempt to request cancellation
          if (currentJobId) {
            statusText.textContent = 'Stopping job: ' + currentJobId + '...';
            try {
              // best-effort cancel: backend should implement /api/stop endpoint that accepts JSON { jobId }
              const resp = await fetch('/api/stop', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ jobId: currentJobId })
              });

              if (!resp.ok) {
                log.textContent += 'Server stop request returned status ' + resp.status + '\n';
                statusText.textContent = '⚠️ Stop request sent (server may not support cancel)';
              } else {
                const rr = await resp.json().catch(() => ({}));
                log.textContent += 'Stop response: ' + JSON.stringify(rr) + '\n';
                statusText.textContent = 'Stopped (requested)';
              }
            } catch (stopErr) {
              log.textContent += 'Stop request error: ' + stopErr + '\n';
              statusText.textContent = 'Stopped (client-side)';
            }

            // clear job id after requesting stop
            currentJobId = null;
          } else {
            // No job id yet — we aborted startup or only client-side state existed
            statusText.textContent = 'Stopped (client-side)';
          }

          // re-enable run button so user can start another job
          runBtn.disabled = false;
        });

        // ensure stop button is disabled at startup
        enableStopButton(false);

    });
</script>
</body>
</html>
